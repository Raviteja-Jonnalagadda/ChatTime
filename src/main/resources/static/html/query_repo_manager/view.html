<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<title>Query Master - View Records</title>

	<!-- Stylesheets -->
	<link rel="stylesheet" href="../../css/min/jquery-ui.css">
	<link rel="stylesheet" href="../../css/min/ui.jqgrid.css">
	<style>
		body {
			font-family: Arial, sans-serif;
			background: #f4f4f4;
			margin: 0;
			padding: 20px;
		}

		h2 {
			text-align: center;
			margin-bottom: 20px;
			color: #333;
		}

		.ctap-viw-tp-btn {
			margin-bottom: 20px;
			text-align: center;
		}

		.ctap-viw-bttn {
			font-family: monospace;
			padding: 10px 20px;
			margin: 5px;
			border: none;
			border-radius: 20px;
			background: linear-gradient(179deg, #22b6f3, #10ec2cf2);
			color: #fff;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.ctap-viw-bttn:hover {
			background: linear-gradient(279deg, #22b6f3, #10ec2cf2);
			transform: scale(1.05);
		}

		.ctap-viw-bttn:disabled {
			background: #ccc !important;
			cursor: not-allowed;
			opacity: 0.6;
		}

		#queryGrid {
			width: 100% !important;
		}

		.ui-jqgrid .ui-jqgrid-bdiv {
			overflow-x: auto !important;
		}

		.ui-jqgrid .cbox {
			display: none !important;
		}

		.ui-icon {
			background-image: url('../../images/min/ui-icons_444444_256x240.png');
		}

		/* Custom Styles for the Selected Row */
		.ui-state-highlight {
			background-color: lightblue !important;
			/* Blue color for selected row */
			color: #000 !important;
		}
	</style>
</head>

<body>

	<h2>Query Master Records</h2>

	<!-- Action Buttons -->
	<div class="ctap-viw-tp-btn">
		<button class="ctap-viw-bttn" id="add_qrepo">Add Query Repo</button>
		<button class="ctap-viw-bttn" id="rfs_qrepo">Refresh Query Repo</button>
		<button class="ctap-viw-bttn" id="edt_qrepo" disabled>Edit Query Repo</button>
		<button class="ctap-viw-bttn" id="del_qrepo" disabled>Delete Query Repo</button>
	</div>

	<!-- Grid Display -->
	<table id="queryGrid"></table>
	<div id="pager"></div>

	<!-- JS Dependencies -->
	<script src="../../js/min/jquery-3.7.1.min.js"></script>
	<script src="../../js/min/jquery-ui.min.js"></script>
	<script src="../../js/min/jquery.jqgrid.min.js"></script>

	<script>
		function qrtable_builder() {
			$("#queryGrid").jqGrid("GridUnload");

			$.ajax({
				url: 'http://localhost:8111/admin/query_repo/view',
				type: 'POST',
				dataType: 'json',
				success: function (response) {
					const gridData = response?.data?.query_data;

					if (!Array.isArray(gridData)) {
						console.error("Invalid data format:", response);
						alert("Unexpected response format from server.");
						return;
					}
					$("#queryGrid").jqGrid({
						datatype: "local",
						data: gridData,
						colModel: [
							{label: 'Query ID', name: 'QUERY_ID', width: 100},
							{label: 'Project ID', name: 'PROJECT_ID', width: 150},
							{label: 'Description', name: 'QUERY_DEC', width: 250},
							{label: 'Query', name: 'QUERY', width: 300},
							{label: 'Query Type', name: 'QUERY_TYPE', width: 100},
							{label: 'CRUD Type', name: 'CRUD_TYPE', width: 80},
							{label: 'Return Type', name: 'RETURN_TYPE', width: 80},
							{label: 'Query Conditions', name: 'QUERY_CONDITIONS', width: 180},
							{label: 'Query Table', name: 'QUERY_TABLE', width: 100},
							{label: 'Query Param Count', name: 'QUERY_PARAM_COUNT', width: 50},
							{label: 'Query Column', name: 'QUERY_COLUMN', width: 100},
							{label: 'Maker ID', name: 'MAKER_ID', width: 100},
							{label: 'Maker Date', name: 'MAKER_DTTM', width: 100}
						],
						autowidth: true,
						shrinkToFit: false,
						viewrecords: true,
						height: 'auto',
						rowList: [20, 40, 60, 80, 100],
						pager: "#pager",
						caption: "Query Repository",
						multiselect: false,
						onSelectRow: function (id) {
							const enable = !!id;
							$('#edt_qrepo, #del_qrepo').prop('disabled', !enable);

							// Prevent setting the selection again if already selected
							const currentSelectedId = $("#queryGrid").jqGrid('getGridParam', 'selrow');
							if (id === currentSelectedId) return;  // Prevent infinite loop

							// Highlight the selected row with light blue
							$("#queryGrid").jqGrid('setSelection', id, true);
							$("#queryGrid").jqGrid('setRowData', id, {}, {background: 'lightblue'});

							// Optionally you can reset the background color for other rows
							$("tr[id!='" + id + "']").css("background", "#bef2b8");
						},
						loadComplete: function () {
							// Change the background color of the pager to blue
							$("#pager").css("background-color", "lightblue");
						}
					});


				},
				error: function (xhr, status, error) {
					console.error("AJAX Error:", error);
					alert("Failed to fetch data from backend.");
				}
			});
		}

		$(document).ready(function () {
			qrtable_builder();

			$('#rfs_qrepo').click(function () {
				qrtable_builder();
			});

			$('#add_qrepo').click(function () {
				window.open('add_query_repo.html', '_blank', 'width=800,height=600');
			});

			$('#edt_qrepo').click(function () {
				const selectedId = $("#queryGrid").jqGrid('getGridParam', 'selrow');
				if (selectedId) {
					const rowData = $("#queryGrid").jqGrid('getRowData', selectedId);
					const queryId = rowData.QUERY_ID;
					window.open('edit_query_repo.html?queryId=' + encodeURIComponent(queryId), '_blank', 'width=800,height=600');
				} else {
					alert("Please select a row first.");
				}
			});

			$('#del_qrepo').click(function () {
				const selectedId = $("#queryGrid").jqGrid('getGridParam', 'selrow');
				if (!selectedId) {
					alert("Please select a row to delete.");
					return;
				}
				const rowData = $("#queryGrid").jqGrid('getRowData', selectedId);
				const queryId = rowData.QUERY_ID;
				const confirmDelete = confirm("Are you sure you want to delete this Query Repo?");

				if (confirmDelete) {
					const rowData = $("#queryGrid").jqGrid('getRowData', selectedId);
					const queryId = rowData.QUERY_ID;
					$.ajax({
						url: 'http://localhost:8111/admin/query_repo/delete',
						method: 'POST',
						data: {queryId: queryId},
						success: function (response) {
							response=JSON.parse(response);
							console.log("Response:", response);

							if (response.sign === 'DONE') {
								alert('Query Repo deleted successfully!');
							} else {
								alert("Delete failed.");
							}
							qrtable_builder();
						},
						error: function (xhr, status, error) {
							alert("Delete failed: " + error);
							qrtable_builder();
						}
					});

				} else {
					console.log("User cancelled deletion.");
				}
			});
		});
	</script>

</body>

</html>